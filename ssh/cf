#!/bin/bash
apt update -y && apt install -y jq curl

# Random subdomain
sub=$(</dev/urandom tr -dc a-z0-9 | head -c5)
DOMAIN="mahboubvps.site"
SUB_DOMAIN="asx-${sub}.${DOMAIN}"
CF_TOKEN="XOYA63kolRF-6_EzxZQ22ESucCdm7zSJl7NEDQtA"
IP=$(curl -s ipv4.icanhazip.com)

echo "[*] Server IP: $IP"
echo "[*] Subdomain to create: $SUB_DOMAIN"

# Zone ID (already verified)
ZONE="8761c8222fe8a4d1249e8563eedf43ee"

# Check if record exists
RECORD_ID=$(curl -sLX GET "https://api.cloudflare.com/client/v4/zones/${ZONE}/dns_records?name=${SUB_DOMAIN}" \
  -H "Authorization: Bearer ${CF_TOKEN}" \
  -H "Content-Type: application/json" | jq -r '.result[0].id')

if [[ -z "$RECORD_ID" || "$RECORD_ID" == "null" ]]; then
  echo "[*] Record does not exist, creating..."
  RECORD_ID=$(curl -sLX POST "https://api.cloudflare.com/client/v4/zones/${ZONE}/dns_records" \
     -H "Authorization: Bearer ${CF_TOKEN}" \
     -H "Content-Type: application/json" \
     --data "{\"type\":\"A\",\"name\":\"${SUB_DOMAIN}\",\"content\":\"${IP}\",\"ttl\":120,\"proxied\":false}" \
     | jq -r '.result.id')
else
  echo "[*] Record exists, updating..."
  curl -sLX PUT "https://api.cloudflare.com/client/v4/zones/${ZONE}/dns_records/${RECORD_ID}" \
     -H "Authorization: Bearer ${CF_TOKEN}" \
     -H "Content-Type: application/json" \
     --data "{\"type\":\"A\",\"name\":\"${SUB_DOMAIN}\",\"content\":\"${IP}\",\"ttl\":120,\"proxied\":false}" >/dev/null
fi

# Save to files
mkdir -p /etc/xray /etc/v2ray /root/xray
echo "$SUB_DOMAIN" | tee /root/domain /etc/xray/domain /etc/v2ray/domain /root/scdomain /root/xray/scdomain > /dev/null
echo "IP=$SUB_DOMAIN" > /var/lib/ipvps.conf

echo "âœ… Subdomain created: $SUB_DOMAIN"
